From d84b922b7fc9294b78e4718159f3b6085b6c2e5a Mon Sep 17 00:00:00 2001
From: Matej Knopp <matej.knopp@gmail.com>
Date: Tue, 30 Jun 2020 18:33:56 +0200
Subject: [PATCH] avauddec: fix buffer leak when send packet failed

Part-of: <https://gitlab.freedesktop.org/gstreamer/gst-libav/-/merge_requests/81>
---
 ext/libav/gstavauddec.c | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/ext/libav/gstavauddec.c b/ext/libav/gstavauddec.c
index d518b702..756f92d6 100644
--- a/ext/libav/gstavauddec.c
+++ b/ext/libav/gstavauddec.c
@@ -701,7 +701,7 @@ gst_ffmpegauddec_handle_frame (GstAudioDecoder * decoder, GstBuffer * inbuf)
   gst_avpacket_init (&packet, data, size);
 
   if (!packet.size)
-    goto done;
+    goto unmap;
 
   if (avcodec_send_packet (ffmpegdec->context, &packet) < 0) {
     goto send_packet_failed;
@@ -729,9 +729,6 @@ gst_ffmpegauddec_handle_frame (GstAudioDecoder * decoder, GstBuffer * inbuf)
     }
   } while (got_frame);
 
-  gst_buffer_unmap (inbuf, &map);
-  gst_buffer_unref (inbuf);
-
   if (is_header || got_any_frames) {
     /* Even if previous return wasn't GST_FLOW_OK, we need to call
      * _finish_frame() since baseclass is expecting that _finish_frame()
@@ -747,6 +744,10 @@ gst_ffmpegauddec_handle_frame (GstAudioDecoder * decoder, GstBuffer * inbuf)
       ret = new_ret;
   }
 
+unmap:
+  gst_buffer_unmap (inbuf, &map);
+  gst_buffer_unref (inbuf);
+
 done:
   return ret;
 
@@ -747,7 +748,7 @@ not_negotiated:
 send_packet_failed:
   {
     GST_WARNING_OBJECT (ffmpegdec, "decoding error");
-    goto done;
+    goto unmap;
   }
 }
 
-- 
GitLab

